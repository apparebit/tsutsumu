#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# DO NOT EDIT! This script was automatically generated
# by Tsutsumu <https://github.com/apparebit/tsutsumu>.
# Manual edits may just break it.

if False: {
# ------------------------------------------------------------------------------
"spam/__init__.py": b"print('spam/__init__.py')\n",
# ------------------------------------------------------------------------------
"spam/__main__.py":
b"""print('spam/__main__.py')
import spam.bacon

print('also:', __file__)
""",
# ------------------------------------------------------------------------------
"spam/bacon.jpg": b"""
s4IA0!"_al8O`[\!<<,,!42_+s5<sN7<iNY!!#_f!%IsK!!iQ.!>5A7!!!!"!!*'"!?(qA!!!!"!
!!!k!?2"B!!!!"!!!!s!AOQU!!!!5!!!"&LM6_k!!!!"!!!":z!!!#+!!!!"!!!#+!!!!"6"FnCA
KXHVEb0H5Ebf_=6W5c@!!Akp!!<3$!!*'#!!&Yn!!E9%!!*'"!;`>j!!E9%!!*'"!/U[U!!*&d!'
!egDffo=BQ%i41G1?]3'p22"9\])z3'p22"=4$J!!!!1e/aM$NrZHgl$s)-m.`nrs1eUH#QT\]q?
$aB!!3`5!tbS6_uLkZ!!*6(!<E3%!<<*"z!!*-'"9eu7#RLhGs24oF&-)b4!s8T-!sJi2"98E&I/
sBO!!El;&g8tq"qsjB#9n.%14bR]#U;[@_%fkqn0Bf!Ee4T)()If*)C6^X-n-W&2)[BQ3BBMq77K
d<8P2o\<E<1'=^#<GAS,RgBkh^2F`qtRH$Y*rKnbA=M2II[Pa.Q$R$jD;USO``Vl6SpZEppG[^Wc
W]#)A'`Q#s>ai`&\eCE.%f\,!;ioB+]k3(smlLFH:o_%qPq"add_uLk[!!<6&!<E3%!<E3$z!!*-
'"9eu7#RLhGs24oF&HDk5!X&W.":#)5"98H(G5qXF!tbY>+Ya065u@kqE>'NOJHurVOeK%r#pV6(
n.fDQd0^X71uTbN(Dn#.-7:2j.Q'+C3&s#e6q'R884cEP<)lt#=BSg;A7]@cBPD4&FEMbNG^4UeK
7nr5LPUeEP*;,qQC!u,R\HRQV5C/hWN*81['d?O\@K2f_o0O6a2lBFdaQ^rf%8R-g>_/RjlYail0
@j2o_%qPq"addgAjS@!WiE)!WiH*!WrQ-!s8Z0"9\i1"U>27"U,&7#R:S>#6tJ>#RC\A#RC\B#mg
nE#n%+K$O[@O$k*OQ$k*OQs4[N@!<N<(!s8W/!s8]9#mUbG%1NaU%1NaU%1NaU%1NaU%1NaU%1Na
U%1NaU%1NaU%1NaU%1NaU%1NaU%1NaU%KG5a"99#5g&MN`!<<05!tbMt!<)hiMC8J!MC8J!MC8J!
MC8J!MC8J!MC8J!MC8J!MC8J!MC8J!MXt2558F)<n6a!J^-(qn_aC?U'oaGp6dKgn-P=0%&d(\c*
!/A*(1Isj'58u&l-kmXT`oVc8u0PqcdKQ=^*3LV_++DTpnI'5a5PmED;f7=OLGZ;hd7R^_.S#oJT
ADRYoTa$Rdo^9g6^f)h3?MT+Rt2iX'AnJnp\Q+/[*jX<!624ZG[0I0Th<*QgZBqo-^#(MehiHY*T
?&V%kH42q*!M?]"^k>[6%;6MEE:/29ULnjpS/8#^+9"7`Q7eA#\3Jf6hWF=gG2RRO@*^s'8,@*-O
FkE4hCi8o@1NoIgEh\#d-nY_;ISdfaA]93=Kn_.7(gg6q@jQ2ZJ7::DsS0$s"k-$12F[TTDgb9(<
eJ^e'<l##SFt1$*r2Y>Q*@l`UI\OT"$_I>&_p3&1?%--LqV;(RF<;EG6cCMo_`HYDX/Q8RYe,YN?
lTjW[r-tR<d[3mNt-D5:OQ<_g81C+B,JffGre5.rr@U1".k,[r1DX:]2\8PVOf+'`V%6;X&u]"D/
jC:'[\fnQ'O5GE^B%X_;NaVh\LT\nL%;If=Yn%h;;Hq"%dV^q)LF[(h"!=$]GVaNg6^tk&hoF4ah
E4EEj#LKj-Z.j)=&1rO;]S"8AGI#Q,9;i#dP57k]V`>>ao9OJb$`9Q<X9dLj>AZ:LJSG\:%11Vmi
$VoCsj;88&r+P1KI_,e-sLNM4=ag$ET>J%aV5;PkcfZhFpLt)_tS7MV.$YG_)!-3#4K)T7,)etOT
7jA@]"utP4p"S\s3ZX`"G#uE-'K7r?[&g'^WWmCt6]S"2LSm"i-Qc>?AS(TWQ<V8:34l2<cd,t9A
)$oqnXJPLM/Eu)f6h;4hb=eXZ'sY=f%\COOW)5=B;]WllWl`/Iqp.[A&+P?GEs:$^".#dcmRMSL,
[]TWadI3Lb%[p)-[1DJ]Y*bYOu&$Va"opC92X"(?)ts(r;>dO?qeQ#Ic(gBA@9$_ZSPP2CHUU<#%
CR?t>Iko>h-M6PGkeF1rFa?#OZVF7]kn:IW].`);M!RU=M=+4BoMj72/#rLc=pg\AA*'X6(qOmR9
A"dDPc\;q^eSf#Eh4-5Ti\KshNI]qn/p/(^ar($68a-q">j3@(qj2GZ2fm-jTRJE7i$Q5ZiA-Y,4
<;!HZ3nj!@b@n(2)/"PC=X'.i%$$?'XJ?n'#9`kEguOm$f-l"G!$$*1U\V+5kMofW__]H?QDVE>4
1OtV?SBRUTE!::r1]&s!2>?!!2>?!!2>?!!2>?!!2>?!!2>?!!2>?!!2scf+gneBlJ[=`$8dd`U8
j08IXkDJa8A8*DZP*FA)Fr`(Ya>P^Rl\>\)5W?XZ%/=P2.I!7LF3q+'*M"f2,dX`HQ.X87tAS2dT
LH^a_YB+QgEOJ)I#M(j&Q34sJGS*I&)uZbFo$.DGNTH[#'hQVj+a&/c1H+t18&OIS,2-R0Aa?PEG
>BKqL1bLgL^O,<<&5H!a,@qeuKkuUSl*7,o*ChHV9ns&qXEZ75b?jc]B/RM)T[@/Uodm=b)Rugq2
E_ODh@Y]Mr!Tt<8#Nf^_%l2#$@FluW?g)rqL>fZ(32K[k2(#b)VYe+pACk[7VHYU8EdgAn%l/5PA
"8ST!utsMDqo8BCRK##Gom##E7c4_QTPb1(p>7#nJmkBMb"tF*0L^j@*QJ1S<Y@PJ-X:.3XV#NF+
,I(ja/hL@?r$<DB;s!Um8r#6c'$-J308>kFMm)o:JZO4+h]Q4)oO`XF,q)jX;Q)jkQUOq<'!%r6H
+IET/Ao+sAP,'!A"m8G;q0?"qk.7\VK"1t90e*"\Ko!,`9Kr5\cra$3i%[N?$RKS_Q/YoVc00HH$
0J:Dh,pRT)G5jdlpjII3.:/[A7P!'_.]L>C<#[)GZ`3fc[^R_+'8ZnI_Ue'j^DOG):%Xg/2X/+-*
4fi?/S#b2/b:>"R]9ZGAVsa0.!"lg[p,2IeG]uU)+_]k<U"b=?8`clrE'k;LZ3R?VXa'!/J#OC_1
uRQ>%H\LfH$I>#a'P:.rr?>Db9&_@O]Gcarr?DOhhK:&YqKf??h43s1:ufZ.d`WFDu`=$VeI968t
Z1Y*9WdT2#VF^2%+1c(lfo`<)PI*49:%!pAS'1<u,*adR4kV_/XZ]RjFII;@u.s8IKtH!5(5K\B/
VBH/s&tGpU+JYYm^nJerC[h0C!#E![NURc;@^>t.TUpFnQQaXO0[V6&@dG8.?U=.@;W6qA8W6Y#9
(8-!kUc4+aDp?d#=0q<&AL44!m`X<cL5TT\2"aW;bYLt6r5OY@dpi<0^_eD5PEkEKkC%`HOO)Z[T
6_*_i,?"E+oGI!Wrr=P>Z'h.$.dff%(C+$.hMXD](W5?*Sj4tjQ2*qZ*9X_YT_LJ*f8d5Q#\\O$[
(;'JdnR3$0Si>SNYPED[./^f28T:;rrB@]U[`4@9j78IikrYTE:`NGN(<T/d":f'N'e5u-sr\gkE
3.Ne_4`'2AVD,fYJ<9[BsW^0Z=s17iDB-M?!W+J,f\EYCD>u]LFrPnN>)/G.*n9o[C/3HnQ4SILc
T[Sea$RP)\r/h6cLNR]`2Ws3^fCU5C?!U5C?!U5C?!U5C?!U5C?!U5C?!U5C?!U5C?!U:cuTJ&_K
gL;+"1:#Cr<LooiKqhk`0Isl@iaB5Rn0#bG5!UjBd^DDB9^DM48b$?+)(TZK;=c4Phag(M%TO>b]
,q[moRE/9-KajR(%P'606V"3D^TA#b/E-M=2U[7q#PO_Uq-EoZVuAW(c(D=LM_EsfnXZeCLUDK=g
$SGM5LHUGi,cNngB0WbA.5QTQKiZqj"Kd9n:T]oJMgjPKY1HbC?^!_8N`G`XYaFU*N*o`K/!+O8K
4?.*+u2"HqE<,=$sL,^XdN:;FWaCHcCEIT*KEcI&(>0!'9."4b\1Sjc.`F*H?:Lp<)m0KlJ#*+s:
=,I*1PB(ru.XCZVTl&oONoE]sBYf;!95r6NhIgnLnbWRn<<7;6DDb5.t+rr=;+2=S8A31Xq5GrKY
R=OagG7s62in,hX5EK<n(d(D5EiSF*/=fg(;-#"3hRRAM+#p_"CXpMlONMDO0Y=H(NX@0g5hdVof
X6*,=OVE=<$!iLB/L6"%cNAA.'P`(G[Z:2tDrt1CQo&tU0cC@`F-<JN@L+5lT]GMt:D13V3M(pE&
&2jY^TZtPr:8Ru2UgC2hH,(S8L[NE1P+[Hg^fZp^_uBs\YuZ5_(&#t(nVF.,[m2:^.U@eJnK/0q7
cP^")-kVR;^<S#jgT7kWlbK8Ic?eX"Z.Bk&,WE8-""*T1s`Sr(@L$WgAl+!d$n@K/msFE(4e3h1/
!<f9',i_ktqZHh9)YWF!V>Y?8V(J:!.?Xo.u^_TCpaUe6,]XJD&A'F]RKH=O^T?hd[r:n1kE'-rQ
VraAhhPFNauE!p4eIV]V;3<m088^X4,Ulf!CG>P/.UtjVf:/5b(I=QCq]=g?10goH'$kU68CjP1B
!).J"?RM62,rKg;)Yp!kJ]k+Cf^PA[K==p%IAZ.H)Ta1UJ/>D0%=2*1^(#mL`Qht)$G\(5!d!8.f
C?$,CmULW)keY\$\14pEd5QLmt*YbiZAhK8YC;e9tAgBn.n@uN(,UTcG\ZT,\<?n3bH)IVJD72iY
<@@l`uE"jj`rXF]K91SU%E1bLH)?pd(Rm>"beQ7MlblMP9H%<PYd+7*p%(1';6''NX8($5A-[l1>
_e+lV>2cU=)U3W+$'?J\s&bJU62\$ngeaB!G-E&b`H\`\uge$O&H8)Tu$)C&q$?TJoG9=q0+M,$N
.Cl!+W5:q:P*t7bb9r2#c/,Rb3rX#@kXETNSCf@5L8mgP;T8Q2Mq]+VM_OB&BB6,o`IC8-S"B%$4
:rtK)9!N7[<&"F,']:\s5V:=7eW6BuImrkHR21e@q`&CCT\\_G!pr6TjICE>S<A.TZ!Y(Q=`mCB?
UkE'I+!n[rrB3[Aa"R`SR^]>a&U)I=\7MskN;MOs3glDU5C?!U5C?!U5C?!U5C?!U5C?!U8hR8(-
6$.\([+c<jp@(BkEpe3715ocGV+5gt.6qT=$WErrD$DZ!jU+f1n,e$kh19]?"ECo0A>H5+0Z(>8'
Jl[:Yc+8F+.SpoI,s)O./`S,A>?.m@fS9=DEl`o?ClmO%r6<ti`7,Q@bTUk4's?_&8T5AJA[M9t#
T4nq#2;4Trfe?oUUH[-cb2uk'P%N#Z"OiSYba?M5#Mb*@#L7t&_CPa]%3.Nd@?-$T=mD7sJ.,]KO
5<AR%j2;9aCdZ+ul$HI5Wch^*fq3JTG^Ebn.+H;eFJURabB[<-]iC?k>./n*GjEEL(&2e-l2498l
f>@XJ8r)[10<i_99<H3oGn0;+9G'oa2a7q^KpA(^!DF\$Q&LXT.HR:\F\B+jc$AmdRTCmZ8/]^!p
*"WOFAL'Ab!Nog[*YNZT[upZ5@&:<bFTu!"_9:YSm'5K?k:o\nq*75s46FCD8>BXpgmpcJYs,)cX
72-()8rcTSMOE@l!3\RFnnoC[UppUf\`fcPuoHjgc8)SMtBMk]U:Ip^Z2W[lnL`&C.[;c/_.S'"n
&>VlR?R6o%c6V>FFg>Jt2X3&V4%Es87d<)FY$eX@^=WB_pR"4B&0pM)Xo-::mKE)tQ4?#CcJG^4^
G`L^qgWKefD)<?JN\`'-")cj3PLlJKi/uAoA(1)m#^@jdP3VIKjL`!^&JPo"B&(US#&m-QM9^N2K
3gua,G@FWOXYRjlh^Ekm8_@.X^t)Gl-_dK^X\>OgA_*P=1u(K%m[_@95H:b*62k-;^ZNX-N)n<Ec
Jl3jOU,5#1RcWGIc:I0=/nK69-Vp2_N&oBk\D6SZB@_cR1kk<n?S>]TBARCMP@<OsVZ\fE))s*WR
SPOkRASSK['R%$&/g@:)-Dof94<bW*JOfkKbjb>ZuiOf1++9C_rPqi<XR%dB==D03*$+nooa"f*m
d=.)\^duOD';\+S!oVGZ;R,_,X/?abj5S!,c?,Um^GO&RhUhM8rG\+=UCSkHKW7rX'=9*eUa.-[Q
Vg>n'V135c['@Z6J>#Nf,?4Xa9Ri12=8(pY$d&DK<]u7HWDf7DgW]4mMZe<+ilO<rWhXrsbWEl%,
B,gE\-(TWDdn1B]6CWX[R0'ChjiXq)!ZEV]n(Po#e2S1#MNJ:2QR8+ju`h$Vijhqf"Khs^[/H",K
Ej.Wa"02kW4&';WCXf73n6[b]*eA0^k;7Vm/,6JQU-DrJhecPO_n,OVn#f0$EK>eri\PYNl,Ijuk
(\o@tY.94^tl7LN_\2=(5Qpj9(:T&m&$0r<]@pEp-1(!<13%EBV'Hb08>Rf*`kDu1W$#Jnj/W;)\
<D\HJ*34M6`TOKX<$C59K,^f#L5DLGsV:'H[+$m5=5=DfdYdI9=%CAb:A,ZO[$MteJL:E\s:ENS*
G$;YqAb_mbk?][f=,$bd?>i:,DZ9\=o8gaQZ1!WobO*#"Gk;Fs8r4/uA"N6k,:jBr^,=$mF"ng/[
.LQ6rZ6G?n7TW*-+&^<fS`kn.auQ,A=@[Hm4p]_j!Og,UF-/4oGT7P/<>JTgnsYZe+]KgHHYdAo!
/"6Fi?A$C$stqHb[_1?grMg$7MX_OSR7tMC8T,e,B3=MC8J!MC8J!MC8J!\.9PV;=GsNX&F0#rE:
-?(N;je84RT`5pJOL^orIk,(AEq@R53RnC#<'Q6_f.euBZ,63e(A7PiS=3QU9bC@SV?+j9@NQP!@
LG2<,?of^O&L@Zt6>V-`OhduQ^!0R*ki\)#@F2D+%lJ<o<m<#rs"IZFT=B"<!+;Q2Aa(<@Mn5mVj
gXj>("dCop#U>77]t%hk?X6/IG)/u^@#/tfYWYS3UQ<*[5:8R=nIsn(`;]fKafTfnrd3=hMg;cbR
*eLhOcPc+ql6;":=tV%e!Afi2bS6)fpa8R=-EfT%\GWa5/P$$1?0::MiJ_'?2&j0^E6DIXImB]/f
DO/@kN%M>"AMJhRsG8eU1Be6hZ3',\Q*QM6>-oddHZb#cs\*E$KpR)13D+[jUs-Xmc$M4s+JTb-k
/CI5S'79:;V+N(5J,.0/B1TWUZ"Q9)aX->b![US6G$!'7A"gN\=n=4/W=:Xf&4Gqp/m(u,cTJ3X,
4hWKDKYKo!E9h\7Il98jm]4][:XD#"s_mKcHUgn)A<n=./LqI5opf>?jrr<R4Uc/o2.nGPr<,tKF
PFd5>qq'(rf!0Y)bq-1pn%j(j#Qp9Al7,@E;NgCaI2n?o64Wf5:i^u<H4Pcp)W,>9Mn>lFQJ`>;+
#Z1@N\GJ=>LT?:KJ'[IhZ!SZ\EK^0Kj=4qp\t4<_<gg;NDAT/MDo"jd76pe5gE)NB7t^O_5+'Des
[ipeRTg90F(Z)ot[bB?O1n#_Y1]TQpdAtrjfaU;F)OI4:H5%W;;Mn`#?\iZ[J!.r0S\\XEK=i)*%
4W!hQ4J*+X0Z3AHoC[:q.:0@f\bUP>=EDNt+PFa\^/8p*,cYHqs.,_@q-q*lZ1AR_<cg&WZo@>6#
lI5m]H#oc]J0W]pfG<+KLjCFCCPLnBe=Mq)n>5;!3FRql>)%+[ZVot\eE'fSp*F%/tUNf/Cf6:*s
QldY+7dni\*:<Tkq5i/YC+t7iD</A0!3acA3G@>b:07,[0)0e2p=BRf-,`WQ_]3[J3$1n@-][lbr
YkQQX*D<!hn`Jag6l46\bTaE69)fI65M#r*1V,RX5VCBMk>k&n^/P48G"D[O6tO,KiO0oo$ikdmt
(`Ea&Bc5r@l]BgDqKThb2F+95@0keehhS@3^a9'gVI-p"UY*;pF7j312bS=sfQ@mq22`D0nJ&&'4
OHN8>1^SL&QqQdRC\mAk05fA_6ml9DR]`VY=Jj13RiYiQ;=V,(HcKYb]&0BZVRKn!Sc&BcEX)!b5
2[emN7Vf/#17jBdhW&a$b5OP!=&>Hp1UZ&(=:23OnQ+P/1%9JV^M*ot9C-IIFT)a6hn8H4(/j2;6
emQXuI$_;CA\4AO`oiZgN]7BX<-*W4c_CMu.'L.uiTX1:)H:1@'s_!fj=B4>f;RucPE_[+KbRBg(
kiZ$5Qqj!5Qqj!5Tg$UrVWCIV15IYqGjTRC3MAc>=\GMSjeMoqQl7gk<jFCN@*JDG)H+-`IG;!^b
5uKXe#3DXmY=bbbP%u*qD(ZOoDp7@Eq.Uo/_nI_R7_b.)3Vl&E?4+]LAfbN3]co_eg&G@CbK3"-J
o'ELqop.d!*jDUYVhl?db^)U0udoPi5od`_*&8)8V>nKs%M*=hh^^*UIN:X_/a>'m<<NY4>'WAr!
FoMkmW2ujS2?]lKCrrCuQpDVV`2N.(EctV3KaA_t*E$W&?J`Y9!(um/'J[L="]"V/BW'>#MLqb"l
()JsWHnc"!-+8j:q6A#rk#pdqVJ!^g8-)Zu.*3b4DrKM9$[qO%mYg7HQjhr.G(Y<?)kgY'>jfRYI
XRj=SZ-$CiguLjrrB'+F$Epfrr<OBdt>U$dH6^tbItY[rq(Li`F"S8hhgN^7_#&e;P$p=Zs:ado&
Ghlmui-?!8]H^T1\-+06(t_jsdJm80[q-42])_is0!j=!71]#id%>]>'-9%p)l_rnXSfX`nU&<]D
^rq'<HrS`Rjn`WsVm&d]p*%"2!Ir&9@;0kTu@ZX<Z9.r?7[6Dt2%`/F5?%";%!cQn.YYE,_[0#LM
3hJM*AGOtAhmQ%+K2-33s5qhIU5NsuB]J\Zi2//AnF:@(OL5etY7r/0Hl9/qJcO>1bZq+]8^6(]X
(!%B!pZOTV4[i$&m4QPuA;+O3;6$7N!hkg/["TX_5Me9b2Nbq^K05k6a#f20-tCVDT:<!(E\]0.A
VtU`aK>DeSi1e]<0L0`IpPNhDhm[qi;5^/D\>Mo\\JX,"/g#mq"iT0(632T(G5cg!4s?Wno-cg6/
.uWei'5^/L*heL)"FX%(RW3aQ`?;p!6h3:E'.B\;3ioQIjcaLe-/Xrq:WsW\0i"I_UI*=F:<'(Hu
#Bhmq,/pJT?iocGsS3$Pj^1(dN`.QI7ZNPH%%+$_X2Q_24Ip=a7K?mCG=k#N<q2Ol:Z6Z,+Cl?d0
p]JAeOS&Y1S-D%C7C)U.-b+aI11EN-ClUq\aWMjWbfjF*^1E5+.*_PI`gb(@.W'#FX<H/c0jV@CQ
rr<&t#6Da7BgNE406q<]4X042;X,ANjK>Cr+a*V2LrfD_8G4-Pn.\uLBL-Ht_])$kFN'q/@>[J?N
QmT>4\-N:lc(EXKe0sY5%*%inXS@U/>"[CCQ_;"!t9Fra_YV:=2+H2_m_S)f.sRf2/h?o7kDoTU1
:66K@g]0/'i?DdSBB2^4#D>o/gs%MHDi%>p@$*OcSHS$43UWG5hP3M8+Bt*>IRrUT_q4J_MI%]Qd
B6p%OAe"k#L^D]Ead([ZE%(0KN_^iq$l89uJ?>9/5F2EVl8/Q9WT"%VkI+(_d4JY)Et`]-`sP&^*
7GUe?L*/2QH\ND>"D)9$I4BaY/(nqZ69-FLBV/O$lO8ph[J,fQL!!-G*_]0`h=o3S5[2$=>-e^ND
h>Fb:nfB=A#>M_WIeQ:cc<bpco]u9&_7DRV4?mcCm1MRd_j6HTqt!G;H:L-O^HmB0("Q5NIdKIU3
],khP\h,9P3A&'okMsV3E2sFhQ;JG;-KBA'N%+!'N%+!'N%+!'N%+!'N%+;s4.&^prWDRp^c?>rr
@m</`Fr<rrBu@k)C)+kk7i0m2&Ys!lZSs)eqCOLEcsniutJo0?,(I4BLQ]).-]t<RrdF3W-jX6Zj
V)0W7h8jJ!_G,[B:>A2.Nu2>3[0?1:e1rr<<%;&>-I"84;S?S:n>-^`m4YX\7V=LS^73[5a8%R:m
,?fI]p>E)fJ%;S6]2=1&%04B"WbeU2I?)-NcE*FG=,Gfi6`-b:>V3ss_N(Hs-qX8c7rV+c:?DmES
"Qd0_4=rVHH`9tFk'Nu7Zhln(BA6A&n*dW\N5q_fra2&@/1*+RJ4AJ_drs8>HKMUd2'X07/H5],D
)A?a9.CKQ&8bc#Z]tcjA9P"3Ig^BV=#Zj8GqqLi=$Lr$2fYIVTI5r\Z)K,?7E)bjIAI%V.`?6#S9
6s`InWq5/g8+l,c8:W55XX?<B"XLfDYg6IODmni2^GOFojAQ!JL8f#>bEbJ22Too_nj;FMPo^=*0
UAr2[_Dn9I*O*h8fc]dZ'0iJ6on]NUK>ArqbjPCfjT64@]Kc3`S1.t>GT?hV12gLe6S*133Gno,Z
S:Dc<f/!@=fXs#4@G"]R4H\FIVF,[JP?%,?e9R)",+YC/t1fEa@+cC5G5ik97!"O)!3;Q^LNGh:j
YVJaYN(TpUc943@i(:sqUYPRHKXD27r>/OihTf2Y8EE*AJUlDQ!.f@l"a9HNSg)Z9`3q=?2UuA/%
X/P]ARjQ+A.H-MFiHs0k:@:3?<PJ>4A86UVNjSO8+Jis:E!rUf1[4u4ODhX5((D5Ku[Lh1QH5X08
LO$Y%;9`)Dk9>B7H=Z(_";%.EMU3alJ#1oBuj-#?I#?c`PtZ9!5FPq5(SH1!5#q<Q@,95H\eP[#Y
H+g3q2S(,kbI]1TqS,f?nB5"O]]4':tiY]c4]f8f]QHsrcK]`.u4(s`;<V^CNo5K!?pbWDf3S&jZ
^c3B\D$+QP+\F6rjj]po.-el%Sp62.a>+Nh#n$0&KXpf(H:#plNnlVoW^aB43(rur>qHiVXQJ0af
'.pgI6SP9P5jH,d5mIfg/DT[I1,I0r(4&;]&gXo($]&9_bBX,40LDRHM90pNL-8'T'u.#O%4gc9\
)#[6NG.<V@bhtNrGVXLA*JIQm(>'N,(RXM9YOq\?5Y'7eHJ3%?Teb$"K;X6FS8`Zl9[g#h"*R`_B
F0?#:]fcG,X+/n\53h>5!+uHAo'b_4nA[q4-MnS;[K?IfMNn?IRiI!dL?Wc7D(&A7Mmc8%]^sej&
+Edc9M!O1LgMe8nl[V^thZ7gVnuoWhP:rWeqao/t6?D]C;JlchB=[q*83q0@9+?A7?4025f^gr><
uO#4`/,^tJ8drmg%L;(=i(Vq'(9&A/snO@>2R7"*@8'@Hbi.1SE\ddEs^DqX!VlTS;i2;0S)f93L
e7s<#\q;=%fkD>cc:b6T9PK.R0Y<QZjsMGNrI0B\G^Bcqp=Z"5[A(,0!4TDOVV\9LF,5(pVCG>#=
[-!a/tT]Qar5/cVs*hofP-ZAgKVYk@uOf:eG>>SP&a.TR_M9+qK*kt`C;?!+.p\N:!-5t.&)Tm"V
ag!"Vag!"Vag!"Vag!"Vag!"Vag!+90pgoCf-QL\rKj-U&SqBlnbaiF#(`no'M<SVdH2bh5E1Sd-
;%PD*iT[E,j2)*)W%%(j,[JG(@fEF+(`dS&CPinhGDgGk']FU)H9jI\"$dC';t%(K_sNcUe,$U$e
E&$jA/Al+HQ_],.$f<.n/YN3q)*Jghf@O6s-\XN/sH7pN>)_]C.%(d#g02!\eg@*PT4A#LB,RsH\
;<0$SB2HlFc9>\m1&5I>n0PQO^[V^_E_<iL)CAb":?Tu7nQsZZk+*+s,__[n%S+^$hufR+Y&i%(_
c!sHHr1?k>=4MBN"O.WIc'O6_8[u_m-2#]T9[gj?nW"'=mYf@O,0+,lf]q%/]pBo7&c?n(j^1e;@
"Y/B:@HAYJZ:Q%3>li95_W^=c@*gF3+N_mS?^:]=g!r=InlT?TVs'6bt@Er8%1p*"(EL4BJEE3d?
U/702<.*!n<>0R;jDY>1Z=V/C%.G31i*)3n2-iM\=?k<:$`J#97#?V;Q"GiT@M532neT"j.Tc$%e
^Kaj7S26i(`44tI@J6Vf#qLCQOI%'Fb+o<p?EqmNTHK<CjiEZrQ"Lte0rOggdOj=.t*a17!,SpP*
JiGXV(4YgLg\2oL<qr#[Rl)^\Za*]0A`n*7aY\Q1@-qlP?UoY*4R0P<C2gO`qbH$4kC\ZP/.NR^_
R;)f>nV2RBm'4IT0Cq3Rq*/"j-6Ou)2Vb&`ud&(3&hlfCO4EE4#Us-#dQ/nb(pFC;L.FgcQ*P0I@
4aF&ptP(\$WQ39m6(H@Z9j4C6C@-'H#'(<BU!]<-eROTb$MKn4!kY=+mYEcC$GNIFsqtoBt<#l>,
U_n1JRe[YjmiqB%_)`%2;qGQ.Y\`I=`J,hI?ZfbSSP4l"$S[C:f,MirPR#c*u_6?CSgUVX\GI!al
[Tt.bB4s/6X4/TZOA?;Io2VXe.PKj2WK7\0srdj8S(\%0QXG3;)brXTR[U8iCD%ai!I%1V/T&f%C
X4b=6HUU[e0t#g(d:g74GPE7;O5oNsMhW"<]\C'qXHNKWT)9?#2g>kMZcB"ZIWiDNUTO7IZR]ZMQ
JG$fqtOM?>5AF_j,"O2e1.*l5SsJ2^ilX'?Zh"EnCU;&@B$3/-,6X5RIOD'_\7s#[)CI7IXe8'U5
CJ*isI3/J-m^!J-m^!J-m^!J-m^!J-m^!J-m^!J-m^!J3X(cr<rS-Iq6k:r,90On\;tiC>V>I7[7
[5#!$0D(8<`<6mS1Ajg6-g`\FpgKdB]1^/sh(!:3Y]@GB"U[_,c$acU'.>8LU]3>qX[63daI6?CW
prL'Cm*5dLdb]KCL9a'PRgL%^:kjTQnR:,:!N>eDTG"l6>B".`%rr?fYCKC#0D>ZVpgY+)dF$8c4
mZ(&mM-pb8SdQDMH<5lHS)M-$qb9Q?_`$4agj#6!nftDsh4?r+KamUC)#do1"+n1W\0''pl!1TFn
i'nT!8'=Cr>?o/Y!9gO[Vh8$ghcZLFkb*kn33<Di]]O9DQPnA9eE3V40L<Ur)*5\n.YMqn[88HlC
K$r!/+8(#EfrW[<H:n$B>\a$Eis_jsh&GJ]SlMr<W0sq\T#D_&BD(-1R8TGf*NL)]&,^>:=(.9;D
^!ihM5!#p!4f`o")N\,2nqYG0587kDMQg-V(dh=UMZG^62*Am!-cI**%JW9Je5\:Hu*!IuV4U;!#
j+JO`A!2>?!!2>?!!2>?!!2>?!!2>?!!2>?!!2>?!!2>?!!2>?!!2>?!!2>?!"97$
""",
# ------------------------------------------------------------------------------
"spam/bacon.py": b"print('spam/bacon.py')\n",
# ------------------------------------------------------------------------------
"spam/ham.html":
b"""<!DOCTYPE html>
<html lang=en>
<meta charset=utf-8>
<title>Ham?</title>
<style>
* {
    margin: 0;
    padding: 0;
}
html {
    height: 100%;
}
body {
    min-height: 100%;
    display: grid;
    justify-content: center;
    align-content: center;
}
img {
    height: calc(15vmin + 1vmax);
    width: auto;
    display: block;
    position: relative;
    left: -20%;
    top: 40%;
}
p {
    font-family: system-ui, sans-serif;
    font-size: calc(30vmin + 3vmax);
    font-weight: bolder;
}
</style>
<img src=bacon.jpg><p>Ham!
""",
}

# ==============================================================================

__manifest__ = {
    "spam/__init__.py": ("t", 305, 30),
    "spam/__main__.py": ("t", 438, 77),
    "spam/bacon.jpg": ("b", 620, 13_003),
    "spam/bacon.py": ("t", 13_726, 27),
    "spam/ham.html": ("t", 13_853, 534),
}

__version__ = '0.2.0'

# ==============================================================================

import base64
from importlib.abc import Loader
from importlib.machinery import ModuleSpec
import importlib.util
import os
import sys
from typing import cast, TYPE_CHECKING

if TYPE_CHECKING:
    from collections.abc import Sequence
    from pathlib import Path
    from types import CodeType, ModuleType


class Bundle(Loader):
    """
    Representation of a bundle. Each instance serves as meta path finder and
    module loader for a particular bundle script.
    """

    @classmethod
    def exec_install(
        cls,
        path: 'str | Path',
    ) -> 'Bundle':
        with open(path, mode='rb') as file:
            content = file.read()

        if (
            content.find(b'\nif False: {\n')
            or content.find(b'=\n\n__manifest__ = {') == -1
            or content.find(b'}\n\n__version__ = "') == -1
        ):
            raise ValueError(f'"{path}" does not appear to be a bundle')

        bindings: 'dict[str, object]' = {}
        exec(content, bindings)
        # cast() would require backwards-compatible type value; comment seems simpler.
        manifest: 'dict[str, tuple[int, int]]' = (
            bindings['__manifest__']) # type: ignore[assignment]
        version = cast(str, bindings['__version__'])

        return cls.install(path, manifest, version)

    @classmethod
    def install(
        cls,
        script: 'str | Path',
        manifest: 'dict[str, tuple[str, int, int]]',
        version: str,
    ) -> 'Bundle':
        bundle = Bundle(script, manifest, version)
        for finder in sys.meta_path:
            if bundle == finder:
                raise ImportError(
                    f'bind "{bundle._script}" is already installed')
        sys.meta_path.insert(0, bundle)
        return bundle

    def __init__(
        self,
        script: 'str | Path',
        manifest: 'dict[str, tuple[str, int, int]]',
        version: str,
    ) -> None:
        script = str(script)
        if not os.path.isabs(script):
            script = os.path.abspath(script)
        if script.endswith('/') or script.endswith(os.sep):
            raise ValueError(
                'path to bundle script "{script}" ends in path separator')

        def intern(path: str) -> str:
            local_path = path.replace('/', os.sep)
            if os.path.isabs(local_path):
                raise ValueError(f'manifest path "{path}" is absolute')
            return os.path.join(script, local_path)

        self._script = script
        self._manifest = {intern(k): v for k, v in manifest.items()}
        self._version = version

    def __hash__(self) -> int:
        return hash(self._script) + hash(self._manifest)

    def __eq__(self, other: object) -> bool:
        if not isinstance(other, Bundle):
            return False
        return (
            self._script == other._script
            and self._manifest == other._manifest
        )

    def __repr__(self) -> str:
        return f'<tsutsumu {self._script}>'

    def __contains__(self, key: str) -> bool:
        return key in self._manifest

    def __getitem__(self, key: str) -> bytes:
        if not key in self._manifest:
            raise ImportError(f'unknown path "{key}"')
        kind, offset, length = self._manifest[key]

        # The bundle dictionary does not include empty files
        if length == 0:
            return b''

        with open(self._script, mode='rb') as file:
            file.seek(offset)
            data = file.read(length)
            assert len(data) == length

            if kind == 't':
                return eval(data)
            elif kind == 'b':
                return base64.a85decode(eval(data))
            elif kind == 'v':
                return data
            else:
                raise ValueError(f'invalid kind "{kind}" for manifest entry')

    def _locate(
        self,
        fullname: str,
        paths: 'None | Sequence[str]' = None,
    ) -> 'tuple[str, None | str]':
        if paths is None:
            prefixes = [os.path.join(
                self._script,
                fullname.replace('.', os.sep)
            )]
        else:
            modname = fullname.rpartition('.')[2]
            prefixes = [os.path.join(path, modname) for path in paths]

        for suffix, is_pkg in (
            (os.sep + '__init__.py', True),
            ('.py', False),
        ):
            for prefix in prefixes:
                fullpath = prefix + suffix
                if fullpath in self._manifest:
                    return fullpath, (prefix if is_pkg else None)

        raise ImportError(
            f'No such module {fullname} in bundle {self._script}')

    def find_spec(
        self,
        fullname: str,
        path: 'None | Sequence[str]' = None,
        target: 'None | ModuleType' = None,
    ) -> 'None | ModuleSpec':
        try:
            fullpath, modpath = self._locate(fullname, path)
        except ImportError:
            return None

        spec = ModuleSpec(fullname, self, origin=fullpath, is_package=bool(modpath))
        if modpath:
            assert spec.submodule_search_locations is not None
            spec.submodule_search_locations.append(modpath)
        return spec

    def create_module(self, spec: ModuleSpec) -> 'None | ModuleType':
        return None

    def exec_module(self, module: 'ModuleType') -> None:
        assert module.__spec__ is not None, 'module must have spec'
        exec(self.get_code(module.__spec__.name), module.__dict__) # type: ignore[misc]

    def is_package(self, fullname: str) -> bool:
        return self._locate(fullname)[1] is not None

    def get_code(self, fullname: str) -> 'CodeType':
        fullpath = self.get_filename(fullname)
        source = importlib.util.decode_source(self[fullpath])
        return compile(source, fullpath, 'exec', dont_inherit=True)

    def get_source(self, fullname: str) -> str:
        return importlib.util.decode_source(self[self.get_filename(fullname)])

    def get_data(self, path: 'str | Path') -> bytes:
        return self[str(path)]

    def get_filename(self, fullname: str) -> str:
        return self._locate(fullname)[0]

    def repackage(self) -> None:
        # Do not repackage if modules exist or their paths are listed in manifest!
        if 'tsutsumu' in sys.modules or 'tsutsumu.bundle' in sys.modules:
            raise ValueError('unable to repackage() already existing modules')

        pkg_path = os.path.join(self._script, 'tsutsumu')
        paths = [os.path.join(pkg_path, file) for file in ('__init__.py', 'bundle.py')]
        if paths[0] in self._manifest or paths[1] in self._manifest:
            raise ValueError('unable to repackage() modules already in manifest')

        # Repackage: Create modules, add attributes, add to manifest.
        package, bundle = self._repackage_create_modules(pkg_path, paths[0], paths[1])
        self._repackage_add_attributes(package, bundle)
        self._repackage_add_to_manifest(package, bundle)

        # If running as __main__ module, remove module.
        if __name__ == '__main__':
            del sys.modules['__main__']

    def _repackage_create_modules(
        self,
        pkg_path: str,
        init_path: str,
        bundle_path: str,
    ) -> 'tuple[ModuleType, ModuleType]':
        for name, path, pkgdir in (
            ('tsutsumu', init_path, pkg_path),
            ('tsutsumu.bundle', bundle_path, None),
        ):
            spec = ModuleSpec(name, self, origin=path, is_package=bool(pkgdir))
            if pkgdir:
                assert spec.submodule_search_locations is not None
                spec.submodule_search_locations.append(pkgdir)
            module = importlib.util.module_from_spec(spec)
            setattr(module, '__file__', path)
            sys.modules[name] = module

        return sys.modules['tsutsumu'], sys.modules['tsutsumu.bundle']

    def _repackage_add_attributes(
        self,
        tsutsumu: 'ModuleType',
        tsutsumu_bundle: 'ModuleType',
    ) -> None:
        for obj, attr, value in (
            (tsutsumu, '__version__', self._version),
            (tsutsumu, 'bundle', tsutsumu_bundle),
            (tsutsumu_bundle, 'Bundle', Bundle),
            (Bundle, '__module__', 'tsutsumu.bundle'),
        ):
            setattr(obj, attr, value)

    def _repackage_add_to_manifest(
        self,
        tsutsumu: 'ModuleType',
        tsutsumu_bundle: 'ModuleType',
    ) -> None:
        hr = b'# ' + b'=' * 78 + b'\n'
        with open(self._script, mode='rb') as file:
            content = file.read()
        index = content.find(hr)
        index = content.find(hr, index + len(hr))
        init_start = content.rfind(b'__version__', 0, index)
        init_length = index - 1 - init_start
        bundle_start = index + len(hr) + 1
        bundle_length = content.find(hr, bundle_start) - 1 - bundle_start

        assert tsutsumu.__file__ is not None
        self._manifest[tsutsumu.__file__] = ('v', init_start, init_length)

        assert tsutsumu_bundle.__file__ is not None
        self._manifest[tsutsumu_bundle.__file__] = ('v', bundle_start, bundle_length)

    def uninstall(self) -> None:
        index = 0
        while index < len(sys.meta_path):
            if self == sys.meta_path[index]:
                del sys.meta_path[index]
            else:
                index += 1

    @staticmethod
    def restrict_sys_path() -> None:
        # FIXME: Maybe, we should disable venv paths, too?!
        cwd = os.getcwd()

        index = 0
        while index < len(sys.path):
            path = sys.path[index]
            if path == '' or path == cwd:
                del sys.path[index]
            else:
                index += 1

    @staticmethod
    def warn(message: str) -> None:
        # Assuming that warnings are infrequent, delay import until use.
        import warnings
        warnings.warn(message)

# ==============================================================================

if __name__ == "__main__":
    import runpy

    # Don't load modules from current directory
    Bundle.restrict_sys_path()

    # Install the bundle
    bundle = Bundle.install(__file__, __manifest__, __version__)

    # This script does not exist. It never ran!
    del sys.modules['__main__']

    # Run equivalent of "python -m spam"
    runpy.run_module("spam", run_name="__main__", alter_sys=True)
